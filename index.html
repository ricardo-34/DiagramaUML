<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>UML ¬∑ Diagrama Interactivo</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0e0f11;--card:#15171c;--border:#1f2230;--border2:#282b38;
  --text:#dde1ee;--dim:#3d4160;--mid:#6b738f;
  --pk:#e8c14a;--fk:#e0615d;--req:#4ec98a;--opt:#3d4160;--enum:#9d7de8;--emb:#d47b3f;
  --web:#4169e1;--mobile:#3daf7a;--cross:#c96d35;
}
body{background:var(--bg);font-family:'Inter',sans-serif;overflow:hidden;height:100vh;width:100vw;user-select:none}

#bar{
  position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:9999;
  display:flex;align-items:center;gap:4px;
  background:rgba(21,23,28,0.96);border:1px solid var(--border2);
  border-radius:12px;padding:6px 8px;backdrop-filter:blur(16px);
  box-shadow:0 8px 28px rgba(0,0,0,0.55);
}
.bt{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:8px;border:none;background:transparent;color:var(--mid);font-size:11px;font-family:'Inter',sans-serif;cursor:pointer;transition:all .15s;white-space:nowrap}
.bt:hover{background:rgba(255,255,255,0.05);color:var(--text)}
.bt.on{background:rgba(65,105,225,0.14);color:#7993f5}
.bt.green{background:rgba(78,201,138,0.1);color:#4ec98a;border:1px solid rgba(78,201,138,0.2)}
.bt.green:hover{background:rgba(78,201,138,0.2);color:#6fd4a8}
.bt.green.active{background:rgba(78,201,138,0.22);color:#5fd09a;border-color:rgba(78,201,138,0.5)}
.bt.off{opacity:.45;pointer-events:none}
.btitle{font-size:12px;font-weight:600;color:var(--text);padding:0 6px;white-space:nowrap}
.sep{width:1px;height:18px;background:var(--border2);margin:0 2px}

#cv{position:absolute;inset:0;overflow:hidden;cursor:default}
#cv::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle,#1c1f2b 1px,transparent 1px);background-size:28px 28px;pointer-events:none;z-index:0}
#ci{position:absolute;top:0;left:0;width:4000px;height:3000px;transform-origin:0 0}
#svgl{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;overflow:visible}

.tc{position:absolute;background:var(--card);border:1px solid var(--border);border-radius:10px;z-index:10;width:230px;cursor:grab;box-shadow:0 4px 18px rgba(0,0,0,0.45);transition:border-color .15s,box-shadow .15s}
.tc:hover{border-color:var(--border2);box-shadow:0 6px 28px rgba(0,0,0,0.6)}
.tc.drag{cursor:grabbing;z-index:999;border-color:var(--web)!important;box-shadow:0 10px 36px rgba(65,105,225,0.18)}
.ch{display:flex;align-items:center;gap:7px;padding:9px 11px;border-radius:9px 9px 0 0;border-bottom:1px solid var(--border)}
.ch.web{border-left:3px solid var(--web)}.ch.mobile{border-left:3px solid var(--mobile)}
.cn{font-size:12.5px;font-weight:600;color:var(--text);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cp{font-size:9px;font-weight:600;letter-spacing:.8px;padding:2px 6px;border-radius:4px;flex-shrink:0}
.cp.web{background:rgba(65,105,225,.12);color:#6b88ff}.cp.mobile{background:rgba(61,175,122,.12);color:#5fd09a}
.tbtn{width:20px;height:20px;border:none;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:4px;color:var(--dim);transition:all .15s;flex-shrink:0}
.tbtn:hover{background:rgba(255,255,255,0.06);color:var(--text)}
.arrow{transition:transform .2s}
.cf{overflow:hidden;transition:max-height .22s ease,opacity .18s}
.cf.open{max-height:2400px;opacity:1}.cf.closed{max-height:0;opacity:0;pointer-events:none}
.fr{display:flex;align-items:center;gap:6px;padding:4.5px 11px;border-bottom:1px solid rgba(255,255,255,.028)}
.fr:last-child{border-bottom:none}.fr.dv{padding:0;border-bottom:1px solid var(--border);pointer-events:none}
.fr.nt{padding:2.5px 11px 2.5px 28px}
.fi{width:11px;font-size:10px;text-align:center;flex-shrink:0;line-height:1}
.fn{font-family:'JetBrains Mono',monospace;font-size:11px;flex:1;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fn.pk{color:var(--pk)}.fn.fk{color:var(--fk)}.fn.opt{color:var(--mid)}.fn.en{color:var(--enum)}.fn.emb{color:var(--emb)}
.ft{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);flex-shrink:0}
.tg{font-size:9px;font-weight:600;padding:1px 5px;border-radius:3px;letter-spacing:.4px;flex-shrink:0}
.tg.pk{background:rgba(232,193,74,.1);color:var(--pk)}.tg.fk{background:rgba(224,97,93,.1);color:var(--fk)}
.tg.r{background:rgba(78,201,138,.08);color:var(--req)}.tg.o{background:rgba(255,255,255,.03);color:var(--dim)}
.tg.e{background:rgba(157,125,232,.1);color:var(--enum)}.tg.emb{background:rgba(212,123,63,.1);color:var(--emb)}
.fn2{font-size:10px;color:var(--dim);font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.csm{padding:5px 11px 7px;font-size:10px;color:var(--dim);display:none;font-family:'JetBrains Mono',monospace}
.cf.closed~.csm{display:block}

/* ‚ïê‚ïê CROP OVERLAY ‚ïê‚ïê */
.crop-shade{position:fixed;background:rgba(0,0,0,0.58);pointer-events:none;z-index:8800;display:none}

#cropFrame{
  position:fixed;z-index:8850;display:none;
  border:2px solid #4ec98a;border-radius:3px;
  pointer-events:all;cursor:move;
}
/* gu√≠as de tercios */
#cropFrame::before{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:
    linear-gradient(rgba(78,201,138,.1) 1px,transparent 1px) 0 33.33% / 100% calc(100%/3) repeat-x,
    linear-gradient(rgba(78,201,138,.1) 1px,transparent 1px) 0 66.66% / 100% calc(100%/3) repeat-x,
    linear-gradient(90deg,rgba(78,201,138,.1) 1px,transparent 1px) 33.33% 0 / calc(100%/3) 100% repeat-y,
    linear-gradient(90deg,rgba(78,201,138,.1) 1px,transparent 1px) 66.66% 0 / calc(100%/3) 100% repeat-y;
}
/* handles de esquina */
.chdl{position:absolute;width:14px;height:14px;z-index:2;border-color:#4ec98a;border-style:solid}
.chdl.tl{top:-1px;left:-1px;border-width:3px 0 0 3px;cursor:nw-resize}
.chdl.tr{top:-1px;right:-1px;border-width:3px 3px 0 0;cursor:ne-resize}
.chdl.bl{bottom:-1px;left:-1px;border-width:0 0 3px 3px;cursor:sw-resize}
.chdl.br{bottom:-1px;right:-1px;border-width:0 3px 3px 0;cursor:se-resize}
/* handles de borde */
.ehdl{position:absolute;background:#4ec98a;border-radius:2px;z-index:2;opacity:.9}
.ehdl.t{top:-4px;left:50%;transform:translateX(-50%);width:30px;height:7px;cursor:n-resize}
.ehdl.b{bottom:-4px;left:50%;transform:translateX(-50%);width:30px;height:7px;cursor:s-resize}
.ehdl.l{left:-4px;top:50%;transform:translateY(-50%);width:7px;height:30px;cursor:w-resize}
.ehdl.r{right:-4px;top:50%;transform:translateY(-50%);width:7px;height:30px;cursor:e-resize}

#cropInfo{
  position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);
  background:rgba(10,11,14,.92);border:1px solid rgba(78,201,138,.35);
  color:#4ec98a;font-size:9.5px;font-family:'JetBrains Mono',monospace;
  padding:3px 12px;border-radius:20px;white-space:nowrap;pointer-events:none;
}

#leg{position:fixed;bottom:14px;left:14px;z-index:9999;background:rgba(21,23,28,0.94);border:1px solid var(--border2);border-radius:10px;padding:11px 13px;backdrop-filter:blur(14px)}
.lt{font-size:9px;font-weight:600;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:7px}
.lr{display:flex;align-items:center;gap:7px;margin-bottom:4px;font-size:10px;color:var(--mid)}
.lr:last-child{margin-bottom:0}
.ld{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.ll{width:18px;height:2px;border-radius:1px;flex-shrink:0}
.lsep{height:1px;background:var(--border);margin:8px 0}
#zi{position:fixed;bottom:14px;right:14px;z-index:9999;background:rgba(21,23,28,0.94);border:1px solid var(--border2);border-radius:7px;padding:5px 9px;font-size:11px;color:var(--mid);backdrop-filter:blur(14px);font-family:'JetBrains Mono',monospace}
#toast{position:fixed;bottom:60px;right:14px;z-index:99999;background:rgba(21,23,28,0.97);border:1px solid var(--border2);border-radius:8px;padding:9px 14px;font-size:11px;color:var(--text);backdrop-filter:blur(14px);display:flex;align-items:center;gap:8px;transform:translateY(20px);opacity:0;transition:all .25s;pointer-events:none}
#toast.show{transform:translateY(0);opacity:1}
#toast .dot{width:7px;height:7px;border-radius:50%;background:#4ec98a;flex-shrink:0;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
</style>
</head>
<body>

<div id="bar">
  <span class="btitle">DB Schema</span>
  <div class="sep"></div>
  <button class="bt" onclick="expandAll()">
    <svg width="12" height="12" viewBox="0 0 12 12"><rect x="1" y="2.5" width="10" height="1.5" rx=".75" fill="currentColor"/><rect x="1" y="5.25" width="10" height="1.5" rx=".75" fill="currentColor"/><rect x="1" y="8" width="10" height="1.5" rx=".75" fill="currentColor"/></svg>
    Expandir
  </button>
  <button class="bt" onclick="collapseAll()">
    <svg width="12" height="12" viewBox="0 0 12 12"><rect x="1" y="5.25" width="10" height="1.5" rx=".75" fill="currentColor"/></svg>
    Colapsar
  </button>
  <div class="sep"></div>
  <button class="bt" onclick="resetLayout()">
    <svg width="12" height="12" viewBox="0 0 12 12"><path d="M1.5 6a4.5 4.5 0 1 1 1.1 3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" fill="none"/><path d="M1.5 9V6h3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
    Reset
  </button>
  <button class="bt" onclick="fitView()">
    <svg width="12" height="12" viewBox="0 0 12 12"><path d="M1 4V1.5h2.5M8.5 1.5H11V4M11 8v2.5H8.5M3.5 10.5H1V8" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
    Fit
  </button>
  <div class="sep"></div>
  <button class="bt on" id="btnLines" onclick="toggleLines()">
    <svg width="12" height="12" viewBox="0 0 12 12"><path d="M1.5 10.5 L10.5 1.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-dasharray="2.5 2"/></svg>
    Relaciones
  </button>
  <div class="sep"></div>
  <button class="bt green" id="btnCrop" onclick="toggleCrop()">
    <svg width="12" height="12" viewBox="0 0 12 12"><rect x="1.5" y="1.5" width="9" height="9" rx="1.5" stroke="currentColor" stroke-width="1.4" fill="none" stroke-dasharray="2.5 1.5"/></svg>
    Marcar √°rea
  </button>
  <button class="bt green" id="btnExport" onclick="exportPNG()" style="display:none">
    <svg width="12" height="12" viewBox="0 0 12 12"><path d="M6 1v7M3 5.5l3 3 3-3M1.5 9.5v1h9v-1" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
    Guardar PNG
  </button>
</div>

<div id="cv">
  <div id="ci">
    <svg id="svgl" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>
</div>

<!-- 4 sombras fuera del recuadro -->
<div id="sT" class="crop-shade"></div>
<div id="sB" class="crop-shade"></div>
<div id="sL" class="crop-shade"></div>
<div id="sR" class="crop-shade"></div>

<!-- recuadro interactivo -->
<div id="cropFrame">
  <div class="chdl tl" data-h="tl"></div>
  <div class="chdl tr" data-h="tr"></div>
  <div class="chdl bl" data-h="bl"></div>
  <div class="chdl br" data-h="br"></div>
  <div class="ehdl t"  data-h="t"></div>
  <div class="ehdl b"  data-h="b"></div>
  <div class="ehdl l"  data-h="l"></div>
  <div class="ehdl r"  data-h="r"></div>
  <div id="cropInfo"></div>
</div>

<div id="leg">
  <div class="lt">Campos</div>
  <div class="lr"><div class="ld" style="background:#e8c14a"></div>PK ‚Äî Primary Key</div>
  <div class="lr"><div class="ld" style="background:#e0615d"></div>FK ‚Äî Foreign Key</div>
  <div class="lr"><div class="ld" style="background:#4ec98a"></div>REQ ‚Äî Requerido</div>
  <div class="lr"><div class="ld" style="background:#3d4160"></div>OPT ‚Äî Opcional</div>
  <div class="lr"><div class="ld" style="background:#9d7de8"></div>ENUM</div>
  <div class="lr"><div class="ld" style="background:#d47b3f"></div>EMBED</div>
  <div class="lsep"></div>
  <div class="lt">Relaciones</div>
  <div class="lr"><div class="ll" style="background:#4169e1;opacity:.8"></div>Web</div>
  <div class="lr"><div class="ll" style="background:#3daf7a;opacity:.8"></div>Mobile</div>
  <div class="lr"><div class="ll" style="background:#c96d35;opacity:.8"></div>Cross-platform</div>
</div>
<div id="zi">100%</div>
<div id="toast"><div class="dot"></div><span id="toastMsg"></span></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATOS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TABLES=[
  {id:'user',name:'User',icon:'üõ°Ô∏è',plat:'web',pos:{x:700,y:50},fields:[
    {n:'_id',t:'ObjectId',g:'pk'},{dv:1},
    {n:'username',t:'String',g:'r',nt:'unique ¬∑ min:3 ¬∑ max:50'},
    {n:'password',t:'String',g:'r',nt:'bcrypt hashed'},
    {n:'email',t:'String',g:'r',nt:'unique ¬∑ lowercase'},{dv:1},
    {n:'role',t:'String',g:'e',nt:'admin'},{dv:1},
    {n:'isActive',t:'Boolean',g:'o'},{n:'createdAt',t:'Date',g:'o'},{n:'updatedAt',t:'Date',g:'o'},
  ]},
  {id:'bodega',name:'Bodega',icon:'üè≠',plat:'web',pos:{x:380,y:430},fields:[
    {n:'_id',t:'ObjectId',g:'pk'},{dv:1},{n:'nombre',t:'String',g:'r'},{n:'direccion',t:'String',g:'r'},
  ]},
  {id:'cliente',name:'Cliente',icon:'üë§',plat:'web',pos:{x:1010,y:430},fields:[
    {n:'_id',t:'ObjectId',g:'pk'},{dv:1},
    {n:'nombre',t:'String',g:'r'},{n:'nunFactura',t:'String',g:'r'},
    {n:'bodegaId',t:'ObjectId',g:'fk',nt:'‚Üí Bodega._id'},{dv:1},
    {n:'cedula',t:'String',g:'o'},{n:'apellido',t:'String',g:'o'},
    {n:'direccion',t:'String',g:'o'},{n:'telefono',t:'String',g:'o'},
    {n:'email',t:'String',g:'o'},{n:'ciudad',t:'String',g:'o'},
    {n:'departamento',t:'String',g:'o'},{n:'pago',t:'String',g:'o'},
    {n:'valorARecibir',t:'Number',g:'o'},{n:'plazoDias',t:'Number',g:'o'},{dv:1},
    {n:'tipoFactura',t:'String',g:'e',nt:'contado | credito'},
    {n:'estadoViaje',t:'String',g:'e',nt:'pendiente | asignado | en_ruta | entregado'},{dv:1},
    {n:'fecha',t:'Date',g:'o'},{n:'codigoViaje',t:'String',g:'o'},
  ]},
  {id:'chofer',name:'Chofer',icon:'üßë‚Äç‚úàÔ∏è',plat:'mobile',pos:{x:60,y:620},fields:[
    {n:'_id',t:'ObjectId',g:'pk'},{dv:1},
    {n:'nombre',t:'String',g:'r'},{n:'email',t:'String',g:'r',nt:'unique ¬∑ lowercase'},
    {n:'password',t:'String',g:'r'},{dv:1},
    {n:'cedula',t:'String',g:'o',nt:'unique sparse'},
    {n:'telefono',t:'String',g:'o'},{n:'direccion',t:'String',g:'o'},
    {n:'licenciaVencimiento',t:'String',g:'o'},{dv:1},
    {n:'vehiculo',t:'Object',g:'emb',nt:'placa ¬∑ capacidad ¬∑ soat ¬∑ tecnomecanico'},{dv:1},
    {n:'perfilCompleto',t:'Boolean',g:'o'},{n:'fechaCreacion',t:'Date',g:'o'},{n:'activo',t:'Boolean',g:'o'},
  ]},
  {id:'viaje',name:'Viaje',icon:'üöö',plat:'web',pos:{x:700,y:620},fields:[
    {n:'_id',t:'ObjectId',g:'pk'},{dv:1},
    {n:'codigo',t:'String',g:'r',nt:'unique ¬∑ n¬∫ planilla'},
    {n:'bodega',t:'ObjectId',g:'fk',nt:'‚Üí Bodega._id'},
    {n:'clientes[ ]',t:'ObjectId[]',g:'fk',nt:'‚Üí Cliente._id'},
    {n:'choferAsignado',t:'ObjectId',g:'fk',nt:'‚Üí Chofer._id'},{dv:1},
    {n:'estado',t:'String',g:'e',nt:'activo | aceptado | completado'},{dv:1},
    {n:'valorFlete',t:'Number',g:'r'},
    {n:'fecha',t:'Date',g:'o'},{n:'fechaAceptacion',t:'Date',g:'o'},{n:'fechaCompletado',t:'Date',g:'o'},{dv:1},
    {n:'pdfs[ ]',t:'Array',g:'emb',nt:'nombre ¬∑ url ¬∑ rutaServidor ¬∑ tipoDocumento ¬∑ fechaSubida ¬∑ subidoPor ¬∑ tamanio'},
  ]},
  {id:'historial',name:'HistorialUbicacion',icon:'üó∫Ô∏è',plat:'mobile',pos:{x:60,y:1140},fields:[
    {n:'_id',t:'ObjectId',g:'pk'},{dv:1},
    {n:'viajeId',t:'String',g:'fk',nt:'unique ¬∑ ‚Üí Viaje._id'},
    {n:'choferId',t:'String',g:'o'},{n:'choferNombre',t:'String',g:'o'},{n:'codigoViaje',t:'String',g:'o'},{dv:1},
    {n:'puntos[ ]',t:'Array',g:'emb',nt:'lat ¬∑ lng ¬∑ vel ¬∑ heading ¬∑ precision ¬∑ timestamp ¬∑ distancia'},
    {n:'ultimaUbicacion',t:'Object',g:'emb',nt:'lat ¬∑ lng ¬∑ vel ¬∑ heading ¬∑ precision ¬∑ timestamp'},{dv:1},
    {n:'distanciaTotal',t:'Number',g:'o'},{n:'cantidadPuntos',t:'Number',g:'o'},
    {n:'activo',t:'Boolean',g:'o'},{n:'fechaInicio',t:'Date',g:'o'},{n:'fechaFin',t:'Date',g:'o'},
    {n:'ultimaActualizacion',t:'Date',g:'o'},{n:'createdAt',t:'Date',g:'o'},
  ]},
  {id:'ubicacion',name:'Ubicacion',icon:'üìç',plat:'mobile',pos:{x:700,y:1100},fields:[
    {n:'_id',t:'ObjectId',g:'pk'},{dv:1},
    {n:'viajeId',t:'String',g:'fk',nt:'indexed ‚Üí Viaje._id'},
    {n:'choferId',t:'String',g:'o'},{n:'choferNombre',t:'String',g:'o'},{n:'codigoViaje',t:'String',g:'o'},{dv:1},
    {n:'latitud',t:'Number',g:'r'},{n:'longitud',t:'Number',g:'r'},
    {n:'velocidad',t:'Number',g:'o'},{n:'heading',t:'Number',g:'o'},{n:'precision',t:'Number',g:'o'},
    {n:'timestamp',t:'Date',g:'o'},{n:'ultimaActualizacion',t:'Date',g:'o'},
    {n:'activo',t:'Boolean',g:'o'},{n:'fechaDetenido',t:'Date',g:'o'},{n:'createdAt',t:'Date',g:'o'},
  ]},
  {id:'clientecomp',name:'ClienteCompletado',icon:'‚úÖ',plat:'mobile',pos:{x:1300,y:1100},fields:[
    {n:'_id',t:'ObjectId',g:'pk'},{dv:1},
    {n:'viajeId',t:'String',g:'fk',nt:'indexed ‚Üí Viaje._id'},
    {n:'nombreCliente',t:'String',g:'r'},{n:'valorARecibir',t:'Number',g:'r'},{n:'valorRecibido',t:'Number',g:'r'},{dv:1},
    {n:'estadoEntrega',t:'String',g:'e',nt:'pendiente | completa | parcial | devolucion'},{dv:1},
    {n:'telefono',t:'String',g:'o'},{n:'direccion',t:'String',g:'o'},{n:'justificacion',t:'String',g:'o'},
    {n:'cedula',t:'String',g:'o'},{n:'email',t:'String',g:'o'},{n:'ciudad',t:'String',g:'o'},
    {n:'fechaCompletado',t:'Date',g:'o'},{n:'codigoViaje',t:'String',g:'o'},
    {n:'fechaViaje',t:'Date',g:'o'},{n:'createdAt',t:'Date',g:'o'},
  ]},
];

const RELS=[
  {from:'cliente',to:'bodega',label:'M:1',type:'web'},
  {from:'viaje',to:'bodega',label:'M:1',type:'web'},
  {from:'viaje',to:'cliente',label:'M:M',type:'web'},
  {from:'viaje',to:'chofer',label:'M:1',type:'cross'},
  {from:'historial',to:'viaje',label:'1:1',type:'mobile'},
  {from:'ubicacion',to:'viaje',label:'M:1',type:'mobile'},
  {from:'clientecomp',to:'viaje',label:'M:1',type:'mobile'},
];

const COLORS={web:'#4169e1',mobile:'#3daf7a',cross:'#c96d35'};
const ICON_MAP={pk:'‚óÜ',fk:'‚¨°',r:'¬∑',o:'¬∑',e:'‚â°',emb:'‚ñ£'};
const IC_COLOR={pk:'#e8c14a',fk:'#e0615d',r:'#4ec98a',o:'#3d4160',e:'#9d7de8',emb:'#d47b3f'};
const FN_CLS={pk:'pk',fk:'fk',r:'',o:'opt',e:'en',emb:'emb'};
const TG_LBL={pk:'PK',fk:'FK',r:'REQ',o:'OPT',e:'ENUM',emb:'EMBED'};

const S={pos:{},collapsed:{},zoom:1,pan:{x:0,y:0},lines:true,panning:false,last:{x:0,y:0}};
TABLES.forEach(t=>{S.pos[t.id]={...t.pos};S.collapsed[t.id]=false;});
const ci=document.getElementById('ci');

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildCard(t){
  const d=document.createElement('div');d.className='tc';d.id='c_'+t.id;
  d.style.left=S.pos[t.id].x+'px';d.style.top=S.pos[t.id].y+'px';
  const h=document.createElement('div');h.className='ch '+t.plat;
  h.innerHTML=`<span style="font-size:13px">${t.icon}</span>
    <span class="cn">${t.name}</span>
    <span class="cp ${t.plat}">${t.plat==='web'?'WEB':'MOB'}</span>
    <button class="tbtn" onclick="toggle('${t.id}',event)">
      <svg class="arrow" id="ar_${t.id}" width="11" height="11" viewBox="0 0 11 11">
        <path d="M2 3.5L5.5 7.5L9 3.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </svg></button>`;
  const f=document.createElement('div');f.className='cf open';f.id='f_'+t.id;
  t.fields.forEach(fl=>{
    if(fl.dv){const r=document.createElement('div');r.className='fr dv';f.appendChild(r);return;}
    const r=document.createElement('div');r.className='fr';
    r.innerHTML=`<span class="fi" style="color:${IC_COLOR[fl.g]}">${ICON_MAP[fl.g]||'¬∑'}</span>
      <span class="fn ${FN_CLS[fl.g]||''}">${fl.n}</span>
      <span class="ft">${fl.t}</span><span class="tg ${fl.g}">${TG_LBL[fl.g]||''}</span>`;
    f.appendChild(r);
    if(fl.nt){const n=document.createElement('div');n.className='fr nt';n.innerHTML=`<span class="fn2">${fl.nt}</span>`;f.appendChild(n);}
  });
  const sm=document.createElement('div');sm.className='csm';sm.id='sm_'+t.id;
  sm.textContent=`${t.fields.filter(x=>!x.dv).length} campos ¬∑ ${t.fields.filter(x=>x.g==='fk').length} FK`;
  d.appendChild(h);d.appendChild(f);d.appendChild(sm);ci.appendChild(d);
  h.addEventListener('mousedown',e=>startDrag(e,t.id));
}
TABLES.forEach(buildCard);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INTERACCI√ìN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggle(id,e){
  e.stopPropagation();S.collapsed[id]=!S.collapsed[id];
  document.getElementById('f_'+id).className='cf '+(S.collapsed[id]?'closed':'open');
  document.getElementById('ar_'+id).style.transform=S.collapsed[id]?'rotate(-90deg)':'';
  setTimeout(drawLines,230);
}
function expandAll(){TABLES.forEach(t=>{S.collapsed[t.id]=false;document.getElementById('f_'+t.id).className='cf open';document.getElementById('ar_'+t.id).style.transform='';});setTimeout(drawLines,230);}
function collapseAll(){TABLES.forEach(t=>{S.collapsed[t.id]=true;document.getElementById('f_'+t.id).className='cf closed';document.getElementById('ar_'+t.id).style.transform='rotate(-90deg)';});setTimeout(drawLines,230);}

function startDrag(e,id){
  if(e.button!==0)return;e.preventDefault();
  const card=document.getElementById('c_'+id);card.classList.add('drag');
  const sx=e.clientX/S.zoom,sy=e.clientY/S.zoom,ox=S.pos[id].x,oy=S.pos[id].y;
  const mv=e2=>{S.pos[id].x=ox+(e2.clientX/S.zoom-sx);S.pos[id].y=oy+(e2.clientY/S.zoom-sy);card.style.left=S.pos[id].x+'px';card.style.top=S.pos[id].y+'px';requestAnimationFrame(drawLines);};
  const up=()=>{card.classList.remove('drag');document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
  document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
}

const cv=document.getElementById('cv');
cv.addEventListener('mousedown',e=>{
  if(!['cv','ci'].includes(e.target.id))return;
  S.panning=true;S.last={x:e.clientX,y:e.clientY};cv.style.cursor='grabbing';
});
document.addEventListener('mousemove',e=>{
  if(!S.panning)return;
  S.pan.x+=e.clientX-S.last.x;S.pan.y+=e.clientY-S.last.y;
  S.last={x:e.clientX,y:e.clientY};applyT();drawLines();
});
document.addEventListener('mouseup',()=>{S.panning=false;cv.style.cursor='default';});
cv.addEventListener('wheel',e=>{
  e.preventDefault();
  const d=e.deltaY<0?1.09:0.92,nz=Math.min(2.5,Math.max(0.25,S.zoom*d));
  const r=cv.getBoundingClientRect();
  S.pan.x=(e.clientX-r.left)-(e.clientX-r.left-S.pan.x)*(nz/S.zoom);
  S.pan.y=(e.clientY-r.top)-(e.clientY-r.top-S.pan.y)*(nz/S.zoom);
  S.zoom=nz;applyT();drawLines();
},{passive:false});

function applyT(){
  ci.style.transform=`translate(${S.pan.x}px,${S.pan.y}px) scale(${S.zoom})`;
  document.getElementById('zi').textContent=Math.round(S.zoom*100)+'%';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SVG L√çNEAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const svg=document.getElementById('svgl');
svg.setAttribute('width','4000');svg.setAttribute('height','3000');

function getRect(id){const el=document.getElementById('c_'+id);if(!el)return null;return{x:S.pos[id].x,y:S.pos[id].y,w:el.offsetWidth,h:el.offsetHeight};}
function ports(r1,r2){
  const cx1=r1.x+r1.w/2,cy1=r1.y+r1.h/2,cx2=r2.x+r2.w/2,cy2=r2.y+r2.h/2;
  if(Math.abs(cx2-cx1)>=Math.abs(cy2-cy1))
    return cx2>cx1?{p1:{x:r1.x+r1.w,y:cy1},p2:{x:r2.x,y:cy2},dir:'h'}:{p1:{x:r1.x,y:cy1},p2:{x:r2.x+r2.w,y:cy2},dir:'h'};
  return cy2>cy1?{p1:{x:cx1,y:r1.y+r1.h},p2:{x:cx2,y:r2.y},dir:'v'}:{p1:{x:cx1,y:r1.y},p2:{x:cx2,y:r2.y+r2.h},dir:'v'};
}
function bz(p1,p2,dir){
  const G=60;
  if(dir==='h'){const g=Math.max(Math.abs(p2.x-p1.x)*.45,G),s=p2.x>p1.x?1:-1;return`M${p1.x},${p1.y} C${p1.x+s*g},${p1.y} ${p2.x-s*g},${p2.y} ${p2.x},${p2.y}`;}
  const g=Math.max(Math.abs(p2.y-p1.y)*.45,G),s=p2.y>p1.y?1:-1;return`M${p1.x},${p1.y} C${p1.x},${p1.y+s*g} ${p2.x},${p2.y-s*g} ${p2.x},${p2.y}`;
}
function svgEl(tag,a){const el=document.createElementNS('http://www.w3.org/2000/svg',tag);Object.entries(a).forEach(([k,v])=>el.setAttribute(k,v));return el;}

function drawLines(){
  svg.innerHTML='';if(!S.lines)return;
  const defs=svgEl('defs',{});
  Object.entries(COLORS).forEach(([type,color])=>{
    const m=svgEl('marker',{id:'mk_'+type,markerWidth:'8',markerHeight:'7',refX:'7',refY:'3.5',orient:'auto',markerUnits:'userSpaceOnUse'});
    m.appendChild(svgEl('polygon',{points:'0,0 0,7 8,3.5',fill:color,opacity:'0.85'}));defs.appendChild(m);
  });
  svg.appendChild(defs);
  RELS.forEach(rel=>{
    const r1=getRect(rel.from),r2=getRect(rel.to);if(!r1||!r2)return;
    const{p1,p2,dir}=ports(r1,r2);const c=COLORS[rel.type];
    const mx=(p1.x+p2.x)/2,my=(p1.y+p2.y)/2;
    svg.appendChild(svgEl('path',{d:bz(p1,p2,dir),stroke:c,'stroke-width':'4',fill:'none',opacity:'0.08'}));
    svg.appendChild(svgEl('path',{d:bz(p1,p2,dir),stroke:c,'stroke-width':'1.8',fill:'none','stroke-dasharray':'6 3',opacity:'0.7','marker-end':`url(#mk_${rel.type})`}));
    svg.appendChild(svgEl('circle',{cx:p1.x,cy:p1.y,r:'4.5',fill:'#e0615d',opacity:'0.9'}));
    svg.appendChild(svgEl('circle',{cx:p1.x,cy:p1.y,r:'2',fill:'#fff',opacity:'0.9'}));
    svg.appendChild(svgEl('circle',{cx:p2.x,cy:p2.y,r:'3.5',fill:c,opacity:'0.7'}));
    svg.appendChild(svgEl('rect',{x:mx-14,y:my-9,width:'28',height:'17',rx:'4',fill:'#0d0f13',stroke:c,'stroke-width':'0.5',opacity:'0.95'}));
    const lbl=svgEl('text',{x:mx,y:my+4.5,'text-anchor':'middle','font-size':'10',fill:c,'font-family':'JetBrains Mono,monospace','font-weight':'600'});
    lbl.textContent=rel.label;svg.appendChild(lbl);
  });
}
function toggleLines(){S.lines=!S.lines;document.getElementById('btnLines').classList.toggle('on',S.lines);drawLines();}
function resetLayout(){TABLES.forEach(t=>{S.pos[t.id]={...t.pos};const c=document.getElementById('c_'+t.id);c.style.left=t.pos.x+'px';c.style.top=t.pos.y+'px';});S.pan={x:0,y:0};S.zoom=1;applyT();drawLines();}
function fitView(){
  const cards=TABLES.map(t=>{const el=document.getElementById('c_'+t.id);return{x:S.pos[t.id].x,y:S.pos[t.id].y,w:el.offsetWidth,h:el.offsetHeight};});
  const minX=Math.min(...cards.map(c=>c.x))-40,minY=Math.min(...cards.map(c=>c.y))-40;
  const maxX=Math.max(...cards.map(c=>c.x+c.w))+40,maxY=Math.max(...cards.map(c=>c.y+c.h))+40;
  const cw=cv.offsetWidth,ch=cv.offsetHeight;
  S.zoom=Math.min(cw/(maxX-minX),ch/(maxY-minY),1.5);
  S.pan.x=(cw-(maxX-minX)*S.zoom)/2-minX*S.zoom;
  S.pan.y=(ch-(maxY-minY)*S.zoom)/2-minY*S.zoom;
  applyT();drawLines();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CROP BOX ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let cropActive=false;
let crop={x:0,y:0,w:800,h:500};
const cropFrame=document.getElementById('cropFrame');
const cropInfoEl=document.getElementById('cropInfo');
const shades=['sT','sB','sL','sR'];

function updateCrop(){
  const{x,y,w,h}=crop;
  cropFrame.style.left=x+'px';cropFrame.style.top=y+'px';
  cropFrame.style.width=w+'px';cropFrame.style.height=h+'px';
  const vw=window.innerWidth,vh=window.innerHeight;
  const s={sT:{l:0,t:0,w:vw,h:y},sB:{l:0,t:y+h,w:vw,h:Math.max(0,vh-y-h)},
           sL:{l:0,t:y,w:x,h:h},sR:{l:x+w,t:y,w:Math.max(0,vw-x-w),h:h}};
  Object.entries(s).forEach(([id,v])=>{
    const el=document.getElementById(id);
    el.style.left=v.l+'px';el.style.top=v.t+'px';el.style.width=v.w+'px';el.style.height=v.h+'px';
  });
  // resoluci√≥n del PNG resultante (2√ó de los p√≠xeles de pantalla)
  const dpr=window.devicePixelRatio||1;
  cropInfoEl.textContent=`${Math.round(w*dpr*2)} √ó ${Math.round(h*dpr*2)} px`;
}

function toggleCrop(){
  cropActive=!cropActive;
  const btn=document.getElementById('btnCrop');
  const expBtn=document.getElementById('btnExport');
  if(cropActive){
    const vw=window.innerWidth,vh=window.innerHeight;
    crop={x:vw*.06,y:70,w:vw*.88,h:vh-90};
    shades.forEach(id=>{document.getElementById(id).style.display='block';});
    cropFrame.style.display='block';
    updateCrop();
    btn.classList.add('active');
    btn.innerHTML=`<svg width="12" height="12" viewBox="0 0 12 12"><path d="M2 10L10 2M2 2l8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg> Cerrar √°rea`;
    expBtn.style.display='flex';
  }else{
    shades.forEach(id=>{document.getElementById(id).style.display='none';});
    cropFrame.style.display='none';
    btn.classList.remove('active');
    btn.innerHTML=`<svg width="12" height="12" viewBox="0 0 12 12"><rect x="1.5" y="1.5" width="9" height="9" rx="1.5" stroke="currentColor" stroke-width="1.4" fill="none" stroke-dasharray="2.5 1.5"/></svg> Marcar √°rea`;
    expBtn.style.display='none';
  }
}

/* mover */
cropFrame.addEventListener('mousedown',e=>{
  const hdl=e.target.closest('[data-h]');
  if(hdl){startResize(e,hdl.dataset.h);return;}
  startMove(e);
});
function startMove(e){
  e.preventDefault();e.stopPropagation();
  const ox=e.clientX-crop.x,oy=e.clientY-crop.y;
  const mv=e2=>{crop.x=e2.clientX-ox;crop.y=e2.clientY-oy;updateCrop();};
  const up=()=>{document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
  document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
}
/* redimensionar */
function startResize(e,h){
  e.preventDefault();e.stopPropagation();
  const MIN=80,sx=e.clientX,sy=e.clientY,sc={...crop};
  const mv=e2=>{
    const dx=e2.clientX-sx,dy=e2.clientY-sy;
    let nx=sc.x,ny=sc.y,nw=sc.w,nh=sc.h;
    if(h==='r'||h==='tr'||h==='br') nw=Math.max(MIN,sc.w+dx);
    if(h==='l'||h==='tl'||h==='bl'){nw=Math.max(MIN,sc.w-dx);nx=sc.x+sc.w-nw;}
    if(h==='b'||h==='bl'||h==='br') nh=Math.max(MIN,sc.h+dy);
    if(h==='t'||h==='tl'||h==='tr'){nh=Math.max(MIN,sc.h-dy);ny=sc.y+sc.h-nh;}
    crop={x:nx,y:ny,w:nw,h:nh};updateCrop();
  };
  const up=()=>{document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
  document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT PNG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ESTRATEGIA: usar la posici√≥n ACTUAL del canvas (sin modificarla)
   y capturar document.body con x/y = crop box en pantalla.
   html2canvas captura lo que se ve en pantalla en esas coordenadas.
   Para alta calidad escalamos el canvas resultado.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function exportPNG(){
  const btn=document.getElementById('btnExport');
  if(btn.classList.contains('off'))return;
  btn.classList.add('off');
  showToast('Preparando captura‚Ä¶');
  await new Promise(r=>setTimeout(r,60));

  // Ocultar recuadro y sombras para la captura
  cropFrame.style.display='none';
  shades.forEach(id=>{document.getElementById(id).style.display='none';});
  document.getElementById('bar').style.display='none';
  document.getElementById('leg').style.display='none';
  document.getElementById('zi').style.display='none';

  await new Promise(r=>setTimeout(r,80));
  showToast('Renderizando‚Ä¶ puede tardar unos segundos');

  try{
    const dpr=window.devicePixelRatio||1;
    // Capturamos el body en coordenadas de pantalla del crop box
    // scale=2 ‚Üí resoluci√≥n doble (alta calidad)
    const canvas=await html2canvas(document.body,{
      backgroundColor:'#0e0f11',
      scale: 2,                     // ‚Üê 2√ó resoluci√≥n
      useCORS:true,
      allowTaint:true,
      x: crop.x,                   // ‚Üê origen del recuadro en pantalla
      y: crop.y,
      width:  crop.w,              // ‚Üê tama√±o del recuadro
      height: crop.h,
      windowWidth:  window.innerWidth,
      windowHeight: window.innerHeight,
      scrollX:0,scrollY:0,
      logging:false,
      imageTimeout:0,
      foreignObjectRendering:false,
    });

    const link=document.createElement('a');
    const ts=new Date().toISOString().slice(0,16).replace(/[:T]/g,'-');
    link.download=`db_schema_${ts}.png`;
    link.href=canvas.toDataURL('image/png',1.0);
    link.click();
    showToast('‚úì PNG guardado correctamente',3000);

  }catch(err){
    console.error(err);
    showToast('Error al exportar. Ver consola.',3500);
  }finally{
    // Restaurar UI
    document.getElementById('bar').style.display='';
    document.getElementById('leg').style.display='';
    document.getElementById('zi').style.display='';
    if(cropActive){
      shades.forEach(id=>{document.getElementById(id).style.display='block';});
      cropFrame.style.display='block';
    }
    btn.classList.remove('off');
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let toastTimer=null;
function showToast(msg,dur=0){
  const t=document.getElementById('toast'),tm=document.getElementById('toastMsg'),dot=t.querySelector('.dot');
  tm.textContent=msg;
  const ok=msg.startsWith('‚úì'),err=msg.startsWith('Error');
  dot.style.background=ok?'#4ec98a':err?'#e0615d':'#4ec98a';
  dot.style.animation=ok||err?'none':'blink 1s infinite';
  t.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);
  if(dur>0)toastTimer=setTimeout(()=>t.classList.remove('show'),dur);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Precargar html2canvas
const s=document.createElement('script');
s.src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
document.head.appendChild(s);

requestAnimationFrame(()=>requestAnimationFrame(()=>{fitView();setTimeout(drawLines,200);}));
</script>
</body>
</html>
